<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		  <meta name="apple-mobile-web-app-capable" content="yes">
		  <meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="description" content="" />
		<meta name="author" content="malcolm" />

		<title>DracoMX</title>
		
		<link rel="stylesheet" href="scripts/jquerymobile/jquery.mobile-1.3.2.min.css">
  	  <script>	$( document ).bind( "mobileinit", function() {
  	  				//alert("mobileinit");
				    // Make your jQuery Mobile framework configuration changes here!
					$.support.cors = true;
				    $.mobile.allowCrossDomainPages = true;
				    
				 }); 
	</script>
	  <!-- jQuery and jQuery Mobile -->
	  <script src="scripts/jquery/jquery-1.9.1.min.js"></script>
	  <script src="scripts/jquerymobile/jquery.mobile-1.3.2.min.js"></script>
	  <script src="phonegap.js"></script>
	  <script src="cordova.js"></script>

		<script>
			var sdomain = "http://192.168.1.109:8099/dracomx";
			$.fn.serializeObject = function()
			{
			    var o = {};
			    var a = this.serializeArray();
			    $.each(a, function() {
			        if (o[this.name] !== undefined) {
			            if (!o[this.name].push) {
			                o[this.name] = [o[this.name]];
			            }
			            o[this.name].push(this.value || '');
			        } else {
			            o[this.name] = this.value || '';
			        }
			    });
			    return o;
			};
			function CreateMessage(MsgName)
			{
				$("#t1").val('@@@@@Create Message'); 
				var PostData =  JSON.parse('{"msgname" : "'  + MsgName + '"}');
				
				//$("#t1").val('=====' + HrefLink); 
				$.support.cors = true;
				$.ajax
					({
					    type: "POST",
					    url: sdomain + "/createmsg",
					    dataType: "text",
					    //contentType: 'application/x-www-form-urlencoded',
					    crossDomain : true,
					    data: PostData,
					    beforeSend: function(x) {
				            if (x && x.overrideMimeType) {
				             	// x.overrideMimeType("application/j-son;charset=UTF-8");
						 		x.overrideMimeType("text/plain");
				            }
				            //x.setRequestHeader("Access-Control-Allow-Origin", "*");
				            //x.setRequestHeader("Origin", "http://192.168.1.109:8099");
					   		x.setRequestHeader("Draco-SessionID", "DracoSessionID");
				           	x.setRequestHeader("Draco-TaskID", "99999999999999999999");
				           	x.setRequestHeader("Draco-JSONRPC", "True");
				
				          },
					    success: function (result) {
					    	$("#t1").val('@@@@@Create Message result ' + result);
					    	var MsgStruct = JSON.parse(result);
							$("#t1").val('@@@@@success---' + MsgStruct.instanceid); 
							localStorage["MsgStruct"] = result;
							//$("#dmxBody").append(MsgStruct.content);
							$("#dmxBody").html(MsgStruct.content);
							//alert('creat msg part - ' + MsgStruct.msgpart);
					        
					    },
					    error: function (data) {
					        //alert((data));
					        $("#t1").val('@@@@@@error---' + JSON.stringify(data)); 
					    }
					})
			}
			function OpenMessage(MsgName,MsgInstanceID)
			{
				$("#t1").val('@@@@@Open Message'); 
				var MsgStruct = JSON.parse(localStorage["MsgStruct"]);
				if (MsgStruct == null)
				{
					alert("null msgstruct");
				}
				if (MsgName == null || MsgName == '' ) 
				{
					MsgName = MsgStruct.msgname;
					MsgInstanceID = MsgStruct.instanceid;
					
				}
				alert("hello ---------- " + MsgStruct.msgpart + "," + MsgInstanceID);
				var FormData = $('#' + MsgStruct.msgpart).serializeObject();
				FormData = JSON.stringify(FormData);
				FormData = FormData.replace('{','');
				alert("FormData= " +FormData);
				if (FormData == null || FormData == '}')
				{
					FormData = '"formdata" : "no"}';
				}
				else
				{
					FormData = FormData.replace('}','');
					FormData += ',"formdata" : "yes"}';
				}
				var PostData =  JSON.parse('{"msgname" : "'  + MsgName + '","msginstanceid" : "' + MsgInstanceID + '",' + FormData);
				alert("postdata--" + JSON.stringify(PostData));
				
				//$("#t1").val('=====' + HrefLink); 
				$.support.cors = true;
				$.ajax
					({
					    type: "POST",
					    url: sdomain + "/openmsg",
					    dataType: "text",
					    //contentType: 'application/x-www-form-urlencoded',
					    crossDomain : true,
					    data: PostData,
					    beforeSend: function(x) {
				            if (x && x.overrideMimeType) {
				             	// x.overrideMimeType("application/j-son;charset=UTF-8");
						 		x.overrideMimeType("text/plain");
				            }
				            //x.setRequestHeader("Access-Control-Allow-Origin", "*");
				            //x.setRequestHeader("Origin", "http://192.168.1.109:8099");
					   		x.setRequestHeader("Draco-SessionID", "DracoSessionID");
				           	x.setRequestHeader("Draco-TaskID", "99999999999999999999");
				           	x.setRequestHeader("Draco-JSONRPC", "True");
				
				          },
					    success: function (result) {
					    	$("#t1").val('@@@@@OPEN success---' ); 
					    	var prevMsgStruct = JSON.parse(localStorage["MsgStruct"]);
					
					    	var MsgStruct = JSON.parse(result);
							$("#t1").val('@@@@@success---' + MsgStruct.instanceid); 
							localStorage["MsgStruct"] = result;
							var ID = $('#dmx' +MsgStruct.msgpart);
							//alert("--ID - " + ID.val());
							if (MsgStruct.msgpart != prevMsgStruct.msgpart)
							{
								alert("append - " + MsgStruct.msgpart);
								$("#dmxBody").append(MsgStruct.content);
							}
							else
							{
								alert("update - " + MsgStruct.msgpart);
								$('#dmx' +MsgStruct.msgpart ).html(MsgStruct.content);
							}
							
							//$("#dmxBody").html(MsgStruct.content);
					        
					    },
					    error: function (data) {
					        //alert((data));
					        $("#t1").val('@@@@@@open error---' + JSON.stringify(data)); 
					    }
					})
			}
		</script>		
		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		
	</head>

	<body>
		
			<div data-role="header" data-position="fixed">
				<h1>DracoMX</h1>
				<input id="t1" name="t1" type="text" />
				<div data-role="navbar">
				    <ul>
				        <li><a href="#" class="ui-btn-active" onclick="CreateMessage('sample1')">Channels</a></li>
				        <li><a href="#">Messages</a></li>
				        <li><a href="#">In Box</a></li>
				    </ul>
				</div><!-- /navbar -->
			</div>
			<div id="dmxBody"> </div>
			<div data-role="footer" data-position="fixed">
				<ul>
				    <li><a href="#" class="ui-btn-active" onclick="OpenMessage('','')">Send</a></li>
				</ul>
			</div>
	</body>
</html>
